/* ------------------------------------------------------------ 	*/
/* TITLE:		 	Assign Referring Physician based on observed IDs*/
/* AUTHOR:		 	Ian McCarthy									*/
/* 				 	Emory University								*/
/* DATE CREATED: 	1/2/2019										*/
/* DATE EDITED:  	4/23/2021										*/
/* CODE FILE ORDER: 8 of 8											*/
/* OUTPUT:			ReferralsCarrier_2008-2018					*/
/* ------------------------------------------------------------ 	*/


%LET year_data=2008;
/* Identify unique inpatient stays */
PROC SQL;
	DROP TABLE WORK.Unique_Stays;
	CREATE TABLE WORK.Unique_Stays AS
	SELECT DISTINCT BENE_ID, CLM_FROM_DT, CLM_THRU_DT, OP_PHYSN_NPI
	FROM IMC969SL.MajorJoint_&year_data
	GROUP BY BENE_ID, CLM_FROM_DT, OP_PHYSN_NPI;
QUIT;



/* January */
PROC SQL;
  DROP TABLE WORK.OpCarrier1_&year_data;
  CREATE TABLE WORK.OpCarrier1_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2008.BCARRIER_LINE_01 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier1_&year_data;
  CREATE TABLE WORK.RefCarrier1_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2008.BCARRIER_CLAIMS_01 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier1_&year_data;
	CREATE TABLE WORK.OpRefCarrier1_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier1_&year_data AS a
	LEFT JOIN WORK.RefCarrier1_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* February */
PROC SQL;
  DROP TABLE WORK.OpCarrier2_&year_data;
  CREATE TABLE WORK.OpCarrier2_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2008.BCARRIER_LINE_02 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier2_&year_data;
  CREATE TABLE WORK.RefCarrier2_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2008.BCARRIER_CLAIMS_02 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier2_&year_data;
	CREATE TABLE WORK.OpRefCarrier2_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier2_&year_data AS a
	LEFT JOIN WORK.RefCarrier2_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* March */
PROC SQL;
  DROP TABLE WORK.OpCarrier3_&year_data;
  CREATE TABLE WORK.OpCarrier3_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2008.BCARRIER_LINE_03 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier3_&year_data;
  CREATE TABLE WORK.RefCarrier3_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2008.BCARRIER_CLAIMS_03 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier3_&year_data;
	CREATE TABLE WORK.OpRefCarrier3_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier3_&year_data AS a
	LEFT JOIN WORK.RefCarrier3_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* April */
PROC SQL;
  DROP TABLE WORK.OpCarrier4_&year_data;
  CREATE TABLE WORK.OpCarrier4_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2008.BCARRIER_LINE_04 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier4_&year_data;
  CREATE TABLE WORK.RefCarrier4_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2008.BCARRIER_CLAIMS_04 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier4_&year_data;
	CREATE TABLE WORK.OpRefCarrier4_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier4_&year_data AS a
	LEFT JOIN WORK.RefCarrier4_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* May */
PROC SQL;
  DROP TABLE WORK.OpCarrier5_&year_data;
  CREATE TABLE WORK.OpCarrier5_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2008.BCARRIER_LINE_05 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier5_&year_data;
  CREATE TABLE WORK.RefCarrier5_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2008.BCARRIER_CLAIMS_05 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier5_&year_data;
	CREATE TABLE WORK.OpRefCarrier5_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier5_&year_data AS a
	LEFT JOIN WORK.RefCarrier5_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* June */
PROC SQL;
  DROP TABLE WORK.OpCarrier6_&year_data;
  CREATE TABLE WORK.OpCarrier6_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2008.BCARRIER_LINE_06 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier6_&year_data;
  CREATE TABLE WORK.RefCarrier6_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2008.BCARRIER_CLAIMS_06 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier6_&year_data;
	CREATE TABLE WORK.OpRefCarrier6_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier6_&year_data AS a
	LEFT JOIN WORK.RefCarrier6_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* July */
PROC SQL;
  DROP TABLE WORK.OpCarrier7_&year_data;
  CREATE TABLE WORK.OpCarrier7_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2008.BCARRIER_LINE_07 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier7_&year_data;
  CREATE TABLE WORK.RefCarrier7_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2008.BCARRIER_CLAIMS_07 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier7_&year_data;
	CREATE TABLE WORK.OpRefCarrier7_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier7_&year_data AS a
	LEFT JOIN WORK.RefCarrier7_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* August */
PROC SQL;
  DROP TABLE WORK.OpCarrier8_&year_data;
  CREATE TABLE WORK.OpCarrier8_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2008.BCARRIER_LINE_08 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier8_&year_data;
  CREATE TABLE WORK.RefCarrier8_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2008.BCARRIER_CLAIMS_08 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier8_&year_data;
	CREATE TABLE WORK.OpRefCarrier8_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier8_&year_data AS a
	LEFT JOIN WORK.RefCarrier8_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* September */
PROC SQL;
  DROP TABLE WORK.OpCarrier9_&year_data;
  CREATE TABLE WORK.OpCarrier9_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2008.BCARRIER_LINE_09 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier9_&year_data;
  CREATE TABLE WORK.RefCarrier9_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2008.BCARRIER_CLAIMS_09 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier9_&year_data;
	CREATE TABLE WORK.OpRefCarrier9_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier9_&year_data AS a
	LEFT JOIN WORK.RefCarrier9_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* October */
PROC SQL;
  DROP TABLE WORK.OpCarrier10_&year_data;
  CREATE TABLE WORK.OpCarrier10_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2008.BCARRIER_LINE_10 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier10_&year_data;
  CREATE TABLE WORK.RefCarrier10_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2008.BCARRIER_CLAIMS_10 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier10_&year_data;
	CREATE TABLE WORK.OpRefCarrier10_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier10_&year_data AS a
	LEFT JOIN WORK.RefCarrier10_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* November */
PROC SQL;
  DROP TABLE WORK.OpCarrier11_&year_data;
  CREATE TABLE WORK.OpCarrier11_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2008.BCARRIER_LINE_11 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier11_&year_data;
  CREATE TABLE WORK.RefCarrier11_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2008.BCARRIER_CLAIMS_11 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier11_&year_data;
	CREATE TABLE WORK.OpRefCarrier11_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier11_&year_data AS a
	LEFT JOIN WORK.RefCarrier11_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* December */
PROC SQL;
  DROP TABLE WORK.OpCarrier12_&year_data;
  CREATE TABLE WORK.OpCarrier12_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2008.BCARRIER_LINE_12 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier12_&year_data;
  CREATE TABLE WORK.RefCarrier12_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2008.BCARRIER_CLAIMS_12 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier12_&year_data;
	CREATE TABLE WORK.OpRefCarrier12_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier12_&year_data AS a
	LEFT JOIN WORK.RefCarrier12_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;


/* Append all months */
DATA IMC969SL.ReferralsCarrier_&year_data;
	SET	WORK.OpRefCarrier1_&year_data
  		WORK.OpRefCarrier2_&year_data
		WORK.OpRefCarrier3_&year_data
		WORK.OpRefCarrier4_&year_data
		WORK.OpRefCarrier5_&year_data
		WORK.OpRefCarrier6_&year_data
		WORK.OpRefCarrier7_&year_data
		WORK.OpRefCarrier8_&year_data
		WORK.OpRefCarrier9_&year_data
		WORK.OpRefCarrier10_&year_data
		WORK.OpRefCarrier11_&year_data
		WORK.OpRefCarrier12_&year_data;
RUN;







%LET year_data=2009;
/* Identify unique inpatient stays */
PROC SQL;
	DROP TABLE WORK.Unique_Stays;
	CREATE TABLE WORK.Unique_Stays AS
	SELECT DISTINCT BENE_ID, CLM_FROM_DT, CLM_THRU_DT, OP_PHYSN_NPI
	FROM IMC969SL.MajorJoint_&year_data
	GROUP BY BENE_ID, CLM_FROM_DT, OP_PHYSN_NPI;
QUIT;



/* January */
PROC SQL;
  DROP TABLE WORK.OpCarrier1_&year_data;
  CREATE TABLE WORK.OpCarrier1_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2009.BCARRIER_LINE_01 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier1_&year_data;
  CREATE TABLE WORK.RefCarrier1_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2009.BCARRIER_CLAIMS_01 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier1_&year_data;
	CREATE TABLE WORK.OpRefCarrier1_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier1_&year_data AS a
	LEFT JOIN WORK.RefCarrier1_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* February */
PROC SQL;
  DROP TABLE WORK.OpCarrier2_&year_data;
  CREATE TABLE WORK.OpCarrier2_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2009.BCARRIER_LINE_02 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier2_&year_data;
  CREATE TABLE WORK.RefCarrier2_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2009.BCARRIER_CLAIMS_02 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier2_&year_data;
	CREATE TABLE WORK.OpRefCarrier2_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier2_&year_data AS a
	LEFT JOIN WORK.RefCarrier2_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* March */
PROC SQL;
  DROP TABLE WORK.OpCarrier3_&year_data;
  CREATE TABLE WORK.OpCarrier3_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2009.BCARRIER_LINE_03 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier3_&year_data;
  CREATE TABLE WORK.RefCarrier3_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2009.BCARRIER_CLAIMS_03 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier3_&year_data;
	CREATE TABLE WORK.OpRefCarrier3_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier3_&year_data AS a
	LEFT JOIN WORK.RefCarrier3_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* April */
PROC SQL;
  DROP TABLE WORK.OpCarrier4_&year_data;
  CREATE TABLE WORK.OpCarrier4_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2009.BCARRIER_LINE_04 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier4_&year_data;
  CREATE TABLE WORK.RefCarrier4_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2009.BCARRIER_CLAIMS_04 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier4_&year_data;
	CREATE TABLE WORK.OpRefCarrier4_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier4_&year_data AS a
	LEFT JOIN WORK.RefCarrier4_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* May */
PROC SQL;
  DROP TABLE WORK.OpCarrier5_&year_data;
  CREATE TABLE WORK.OpCarrier5_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2009.BCARRIER_LINE_05 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier5_&year_data;
  CREATE TABLE WORK.RefCarrier5_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2009.BCARRIER_CLAIMS_05 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier5_&year_data;
	CREATE TABLE WORK.OpRefCarrier5_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier5_&year_data AS a
	LEFT JOIN WORK.RefCarrier5_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* June */
PROC SQL;
  DROP TABLE WORK.OpCarrier6_&year_data;
  CREATE TABLE WORK.OpCarrier6_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2009.BCARRIER_LINE_06 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier6_&year_data;
  CREATE TABLE WORK.RefCarrier6_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2009.BCARRIER_CLAIMS_06 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier6_&year_data;
	CREATE TABLE WORK.OpRefCarrier6_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier6_&year_data AS a
	LEFT JOIN WORK.RefCarrier6_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* July */
PROC SQL;
  DROP TABLE WORK.OpCarrier7_&year_data;
  CREATE TABLE WORK.OpCarrier7_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2009.BCARRIER_LINE_07 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier7_&year_data;
  CREATE TABLE WORK.RefCarrier7_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2009.BCARRIER_CLAIMS_07 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier7_&year_data;
	CREATE TABLE WORK.OpRefCarrier7_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier7_&year_data AS a
	LEFT JOIN WORK.RefCarrier7_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* August */
PROC SQL;
  DROP TABLE WORK.OpCarrier8_&year_data;
  CREATE TABLE WORK.OpCarrier8_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2009.BCARRIER_LINE_08 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier8_&year_data;
  CREATE TABLE WORK.RefCarrier8_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2009.BCARRIER_CLAIMS_08 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier8_&year_data;
	CREATE TABLE WORK.OpRefCarrier8_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier8_&year_data AS a
	LEFT JOIN WORK.RefCarrier8_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* September */
PROC SQL;
  DROP TABLE WORK.OpCarrier9_&year_data;
  CREATE TABLE WORK.OpCarrier9_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2009.BCARRIER_LINE_09 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier9_&year_data;
  CREATE TABLE WORK.RefCarrier9_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2009.BCARRIER_CLAIMS_09 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier9_&year_data;
	CREATE TABLE WORK.OpRefCarrier9_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier9_&year_data AS a
	LEFT JOIN WORK.RefCarrier9_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* October */
PROC SQL;
  DROP TABLE WORK.OpCarrier10_&year_data;
  CREATE TABLE WORK.OpCarrier10_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2009.BCARRIER_LINE_10 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier10_&year_data;
  CREATE TABLE WORK.RefCarrier10_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2009.BCARRIER_CLAIMS_10 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier10_&year_data;
	CREATE TABLE WORK.OpRefCarrier10_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier10_&year_data AS a
	LEFT JOIN WORK.RefCarrier10_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* November */
PROC SQL;
  DROP TABLE WORK.OpCarrier11_&year_data;
  CREATE TABLE WORK.OpCarrier11_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2009.BCARRIER_LINE_11 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier11_&year_data;
  CREATE TABLE WORK.RefCarrier11_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2009.BCARRIER_CLAIMS_11 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier11_&year_data;
	CREATE TABLE WORK.OpRefCarrier11_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier11_&year_data AS a
	LEFT JOIN WORK.RefCarrier11_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* December */
PROC SQL;
  DROP TABLE WORK.OpCarrier12_&year_data;
  CREATE TABLE WORK.OpCarrier12_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2009.BCARRIER_LINE_12 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier12_&year_data;
  CREATE TABLE WORK.RefCarrier12_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2009.BCARRIER_CLAIMS_12 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier12_&year_data;
	CREATE TABLE WORK.OpRefCarrier12_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier12_&year_data AS a
	LEFT JOIN WORK.RefCarrier12_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;


/* Append all months */
DATA IMC969SL.ReferralsCarrier_&year_data;
	SET	WORK.OpRefCarrier1_&year_data
  		WORK.OpRefCarrier2_&year_data
		WORK.OpRefCarrier3_&year_data
		WORK.OpRefCarrier4_&year_data
		WORK.OpRefCarrier5_&year_data
		WORK.OpRefCarrier6_&year_data
		WORK.OpRefCarrier7_&year_data
		WORK.OpRefCarrier8_&year_data
		WORK.OpRefCarrier9_&year_data
		WORK.OpRefCarrier10_&year_data
		WORK.OpRefCarrier11_&year_data
		WORK.OpRefCarrier12_&year_data;
RUN;



%LET year_data=2010;
/* Identify unique inpatient stays */
PROC SQL;
	DROP TABLE WORK.Unique_Stays;
	CREATE TABLE WORK.Unique_Stays AS
	SELECT DISTINCT BENE_ID, CLM_FROM_DT, CLM_THRU_DT, OP_PHYSN_NPI
	FROM IMC969SL.MajorJoint_&year_data
	GROUP BY BENE_ID, CLM_FROM_DT, OP_PHYSN_NPI;
QUIT;



/* January */
PROC SQL;
  DROP TABLE WORK.OpCarrier1_&year_data;
  CREATE TABLE WORK.OpCarrier1_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2010.BCARRIER_LINE_01 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier1_&year_data;
  CREATE TABLE WORK.RefCarrier1_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2010.BCARRIER_CLAIMS_01 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier1_&year_data;
	CREATE TABLE WORK.OpRefCarrier1_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier1_&year_data AS a
	LEFT JOIN WORK.RefCarrier1_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* February */
PROC SQL;
  DROP TABLE WORK.OpCarrier2_&year_data;
  CREATE TABLE WORK.OpCarrier2_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2010.BCARRIER_LINE_02 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier2_&year_data;
  CREATE TABLE WORK.RefCarrier2_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2010.BCARRIER_CLAIMS_02 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier2_&year_data;
	CREATE TABLE WORK.OpRefCarrier2_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier2_&year_data AS a
	LEFT JOIN WORK.RefCarrier2_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* March */
PROC SQL;
  DROP TABLE WORK.OpCarrier3_&year_data;
  CREATE TABLE WORK.OpCarrier3_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2010.BCARRIER_LINE_03 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier3_&year_data;
  CREATE TABLE WORK.RefCarrier3_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2010.BCARRIER_CLAIMS_03 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier3_&year_data;
	CREATE TABLE WORK.OpRefCarrier3_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier3_&year_data AS a
	LEFT JOIN WORK.RefCarrier3_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* April */
PROC SQL;
  DROP TABLE WORK.OpCarrier4_&year_data;
  CREATE TABLE WORK.OpCarrier4_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2010.BCARRIER_LINE_04 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier4_&year_data;
  CREATE TABLE WORK.RefCarrier4_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2010.BCARRIER_CLAIMS_04 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier4_&year_data;
	CREATE TABLE WORK.OpRefCarrier4_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier4_&year_data AS a
	LEFT JOIN WORK.RefCarrier4_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* May */
PROC SQL;
  DROP TABLE WORK.OpCarrier5_&year_data;
  CREATE TABLE WORK.OpCarrier5_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2010.BCARRIER_LINE_05 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier5_&year_data;
  CREATE TABLE WORK.RefCarrier5_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2010.BCARRIER_CLAIMS_05 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier5_&year_data;
	CREATE TABLE WORK.OpRefCarrier5_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier5_&year_data AS a
	LEFT JOIN WORK.RefCarrier5_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* June */
PROC SQL;
  DROP TABLE WORK.OpCarrier6_&year_data;
  CREATE TABLE WORK.OpCarrier6_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2010.BCARRIER_LINE_06 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier6_&year_data;
  CREATE TABLE WORK.RefCarrier6_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2010.BCARRIER_CLAIMS_06 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier6_&year_data;
	CREATE TABLE WORK.OpRefCarrier6_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier6_&year_data AS a
	LEFT JOIN WORK.RefCarrier6_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* July */
PROC SQL;
  DROP TABLE WORK.OpCarrier7_&year_data;
  CREATE TABLE WORK.OpCarrier7_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2010.BCARRIER_LINE_07 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier7_&year_data;
  CREATE TABLE WORK.RefCarrier7_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2010.BCARRIER_CLAIMS_07 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier7_&year_data;
	CREATE TABLE WORK.OpRefCarrier7_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier7_&year_data AS a
	LEFT JOIN WORK.RefCarrier7_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* August */
PROC SQL;
  DROP TABLE WORK.OpCarrier8_&year_data;
  CREATE TABLE WORK.OpCarrier8_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2010.BCARRIER_LINE_08 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier8_&year_data;
  CREATE TABLE WORK.RefCarrier8_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2010.BCARRIER_CLAIMS_08 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier8_&year_data;
	CREATE TABLE WORK.OpRefCarrier8_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier8_&year_data AS a
	LEFT JOIN WORK.RefCarrier8_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* September */
PROC SQL;
  DROP TABLE WORK.OpCarrier9_&year_data;
  CREATE TABLE WORK.OpCarrier9_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2010.BCARRIER_LINE_09 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier9_&year_data;
  CREATE TABLE WORK.RefCarrier9_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2010.BCARRIER_CLAIMS_09 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier9_&year_data;
	CREATE TABLE WORK.OpRefCarrier9_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier9_&year_data AS a
	LEFT JOIN WORK.RefCarrier9_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* October */
PROC SQL;
  DROP TABLE WORK.OpCarrier10_&year_data;
  CREATE TABLE WORK.OpCarrier10_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2010.BCARRIER_LINE_10 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier10_&year_data;
  CREATE TABLE WORK.RefCarrier10_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2010.BCARRIER_CLAIMS_10 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier10_&year_data;
	CREATE TABLE WORK.OpRefCarrier10_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier10_&year_data AS a
	LEFT JOIN WORK.RefCarrier10_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* November */
PROC SQL;
  DROP TABLE WORK.OpCarrier11_&year_data;
  CREATE TABLE WORK.OpCarrier11_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2010.BCARRIER_LINE_11 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier11_&year_data;
  CREATE TABLE WORK.RefCarrier11_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2010.BCARRIER_CLAIMS_11 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier11_&year_data;
	CREATE TABLE WORK.OpRefCarrier11_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier11_&year_data AS a
	LEFT JOIN WORK.RefCarrier11_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* December */
PROC SQL;
  DROP TABLE WORK.OpCarrier12_&year_data;
  CREATE TABLE WORK.OpCarrier12_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2010.BCARRIER_LINE_12 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier12_&year_data;
  CREATE TABLE WORK.RefCarrier12_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2010.BCARRIER_CLAIMS_12 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier12_&year_data;
	CREATE TABLE WORK.OpRefCarrier12_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier12_&year_data AS a
	LEFT JOIN WORK.RefCarrier12_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;


/* Append all months */
DATA IMC969SL.ReferralsCarrier_&year_data;
	SET	WORK.OpRefCarrier1_&year_data
  		WORK.OpRefCarrier2_&year_data
		WORK.OpRefCarrier3_&year_data
		WORK.OpRefCarrier4_&year_data
		WORK.OpRefCarrier5_&year_data
		WORK.OpRefCarrier6_&year_data
		WORK.OpRefCarrier7_&year_data
		WORK.OpRefCarrier8_&year_data
		WORK.OpRefCarrier9_&year_data
		WORK.OpRefCarrier10_&year_data
		WORK.OpRefCarrier11_&year_data
		WORK.OpRefCarrier12_&year_data;
RUN;



%LET year_data=2011;
/* Identify unique inpatient stays */
PROC SQL;
	DROP TABLE WORK.Unique_Stays;
	CREATE TABLE WORK.Unique_Stays AS
	SELECT DISTINCT BENE_ID, CLM_FROM_DT, CLM_THRU_DT, OP_PHYSN_NPI
	FROM IMC969SL.MajorJoint_&year_data
	GROUP BY BENE_ID, CLM_FROM_DT, OP_PHYSN_NPI;
QUIT;



/* January */
PROC SQL;
  DROP TABLE WORK.OpCarrier1_&year_data;
  CREATE TABLE WORK.OpCarrier1_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2011.BCARRIER_LINE_01 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier1_&year_data;
  CREATE TABLE WORK.RefCarrier1_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2011.BCARRIER_CLAIMS_01 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier1_&year_data;
	CREATE TABLE WORK.OpRefCarrier1_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier1_&year_data AS a
	LEFT JOIN WORK.RefCarrier1_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* February */
PROC SQL;
  DROP TABLE WORK.OpCarrier2_&year_data;
  CREATE TABLE WORK.OpCarrier2_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2011.BCARRIER_LINE_02 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier2_&year_data;
  CREATE TABLE WORK.RefCarrier2_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2011.BCARRIER_CLAIMS_02 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier2_&year_data;
	CREATE TABLE WORK.OpRefCarrier2_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier2_&year_data AS a
	LEFT JOIN WORK.RefCarrier2_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* March */
PROC SQL;
  DROP TABLE WORK.OpCarrier3_&year_data;
  CREATE TABLE WORK.OpCarrier3_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2011.BCARRIER_LINE_03 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier3_&year_data;
  CREATE TABLE WORK.RefCarrier3_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2011.BCARRIER_CLAIMS_03 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier3_&year_data;
	CREATE TABLE WORK.OpRefCarrier3_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier3_&year_data AS a
	LEFT JOIN WORK.RefCarrier3_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* April */
PROC SQL;
  DROP TABLE WORK.OpCarrier4_&year_data;
  CREATE TABLE WORK.OpCarrier4_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2011.BCARRIER_LINE_04 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier4_&year_data;
  CREATE TABLE WORK.RefCarrier4_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2011.BCARRIER_CLAIMS_04 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier4_&year_data;
	CREATE TABLE WORK.OpRefCarrier4_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier4_&year_data AS a
	LEFT JOIN WORK.RefCarrier4_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* May */
PROC SQL;
  DROP TABLE WORK.OpCarrier5_&year_data;
  CREATE TABLE WORK.OpCarrier5_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2011.BCARRIER_LINE_05 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier5_&year_data;
  CREATE TABLE WORK.RefCarrier5_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2011.BCARRIER_CLAIMS_05 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier5_&year_data;
	CREATE TABLE WORK.OpRefCarrier5_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier5_&year_data AS a
	LEFT JOIN WORK.RefCarrier5_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* June */
PROC SQL;
  DROP TABLE WORK.OpCarrier6_&year_data;
  CREATE TABLE WORK.OpCarrier6_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2011.BCARRIER_LINE_06 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier6_&year_data;
  CREATE TABLE WORK.RefCarrier6_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2011.BCARRIER_CLAIMS_06 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier6_&year_data;
	CREATE TABLE WORK.OpRefCarrier6_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier6_&year_data AS a
	LEFT JOIN WORK.RefCarrier6_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* July */
PROC SQL;
  DROP TABLE WORK.OpCarrier7_&year_data;
  CREATE TABLE WORK.OpCarrier7_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2011.BCARRIER_LINE_07 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier7_&year_data;
  CREATE TABLE WORK.RefCarrier7_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2011.BCARRIER_CLAIMS_07 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier7_&year_data;
	CREATE TABLE WORK.OpRefCarrier7_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier7_&year_data AS a
	LEFT JOIN WORK.RefCarrier7_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* August */
PROC SQL;
  DROP TABLE WORK.OpCarrier8_&year_data;
  CREATE TABLE WORK.OpCarrier8_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2011.BCARRIER_LINE_08 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier8_&year_data;
  CREATE TABLE WORK.RefCarrier8_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2011.BCARRIER_CLAIMS_08 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier8_&year_data;
	CREATE TABLE WORK.OpRefCarrier8_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier8_&year_data AS a
	LEFT JOIN WORK.RefCarrier8_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* September */
PROC SQL;
  DROP TABLE WORK.OpCarrier9_&year_data;
  CREATE TABLE WORK.OpCarrier9_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2011.BCARRIER_LINE_09 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier9_&year_data;
  CREATE TABLE WORK.RefCarrier9_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2011.BCARRIER_CLAIMS_09 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier9_&year_data;
	CREATE TABLE WORK.OpRefCarrier9_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier9_&year_data AS a
	LEFT JOIN WORK.RefCarrier9_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* October */
PROC SQL;
  DROP TABLE WORK.OpCarrier10_&year_data;
  CREATE TABLE WORK.OpCarrier10_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2011.BCARRIER_LINE_10 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier10_&year_data;
  CREATE TABLE WORK.RefCarrier10_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2011.BCARRIER_CLAIMS_10 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier10_&year_data;
	CREATE TABLE WORK.OpRefCarrier10_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier10_&year_data AS a
	LEFT JOIN WORK.RefCarrier10_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* November */
PROC SQL;
  DROP TABLE WORK.OpCarrier11_&year_data;
  CREATE TABLE WORK.OpCarrier11_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2011.BCARRIER_LINE_11 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier11_&year_data;
  CREATE TABLE WORK.RefCarrier11_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2011.BCARRIER_CLAIMS_11 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier11_&year_data;
	CREATE TABLE WORK.OpRefCarrier11_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier11_&year_data AS a
	LEFT JOIN WORK.RefCarrier11_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* December */
PROC SQL;
  DROP TABLE WORK.OpCarrier12_&year_data;
  CREATE TABLE WORK.OpCarrier12_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2011.BCARRIER_LINE_12 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier12_&year_data;
  CREATE TABLE WORK.RefCarrier12_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2011.BCARRIER_CLAIMS_12 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier12_&year_data;
	CREATE TABLE WORK.OpRefCarrier12_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier12_&year_data AS a
	LEFT JOIN WORK.RefCarrier12_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;


/* Append all months */
DATA IMC969SL.ReferralsCarrier_&year_data;
	SET	WORK.OpRefCarrier1_&year_data
  		WORK.OpRefCarrier2_&year_data
		WORK.OpRefCarrier3_&year_data
		WORK.OpRefCarrier4_&year_data
		WORK.OpRefCarrier5_&year_data
		WORK.OpRefCarrier6_&year_data
		WORK.OpRefCarrier7_&year_data
		WORK.OpRefCarrier8_&year_data
		WORK.OpRefCarrier9_&year_data
		WORK.OpRefCarrier10_&year_data
		WORK.OpRefCarrier11_&year_data
		WORK.OpRefCarrier12_&year_data;
RUN;




%LET year_data=2012;
/* Identify unique inpatient stays */
PROC SQL;
	DROP TABLE WORK.Unique_Stays;
	CREATE TABLE WORK.Unique_Stays AS
	SELECT DISTINCT BENE_ID, CLM_FROM_DT, CLM_THRU_DT, OP_PHYSN_NPI
	FROM IMC969SL.MajorJoint_&year_data
	GROUP BY BENE_ID, CLM_FROM_DT, OP_PHYSN_NPI;
QUIT;



/* January */
PROC SQL;
  DROP TABLE WORK.OpCarrier1_&year_data;
  CREATE TABLE WORK.OpCarrier1_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2012.BCARRIER_LINE_01 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier1_&year_data;
  CREATE TABLE WORK.RefCarrier1_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2012.BCARRIER_CLAIMS_01 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier1_&year_data;
	CREATE TABLE WORK.OpRefCarrier1_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier1_&year_data AS a
	LEFT JOIN WORK.RefCarrier1_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* February */
PROC SQL;
  DROP TABLE WORK.OpCarrier2_&year_data;
  CREATE TABLE WORK.OpCarrier2_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2012.BCARRIER_LINE_02 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier2_&year_data;
  CREATE TABLE WORK.RefCarrier2_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2012.BCARRIER_CLAIMS_02 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier2_&year_data;
	CREATE TABLE WORK.OpRefCarrier2_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier2_&year_data AS a
	LEFT JOIN WORK.RefCarrier2_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* March */
PROC SQL;
  DROP TABLE WORK.OpCarrier3_&year_data;
  CREATE TABLE WORK.OpCarrier3_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2012.BCARRIER_LINE_03 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier3_&year_data;
  CREATE TABLE WORK.RefCarrier3_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2012.BCARRIER_CLAIMS_03 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier3_&year_data;
	CREATE TABLE WORK.OpRefCarrier3_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier3_&year_data AS a
	LEFT JOIN WORK.RefCarrier3_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* April */
PROC SQL;
  DROP TABLE WORK.OpCarrier4_&year_data;
  CREATE TABLE WORK.OpCarrier4_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2012.BCARRIER_LINE_04 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier4_&year_data;
  CREATE TABLE WORK.RefCarrier4_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2012.BCARRIER_CLAIMS_04 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier4_&year_data;
	CREATE TABLE WORK.OpRefCarrier4_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier4_&year_data AS a
	LEFT JOIN WORK.RefCarrier4_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* May */
PROC SQL;
  DROP TABLE WORK.OpCarrier5_&year_data;
  CREATE TABLE WORK.OpCarrier5_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2012.BCARRIER_LINE_05 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier5_&year_data;
  CREATE TABLE WORK.RefCarrier5_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2012.BCARRIER_CLAIMS_05 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier5_&year_data;
	CREATE TABLE WORK.OpRefCarrier5_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier5_&year_data AS a
	LEFT JOIN WORK.RefCarrier5_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* June */
PROC SQL;
  DROP TABLE WORK.OpCarrier6_&year_data;
  CREATE TABLE WORK.OpCarrier6_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2012.BCARRIER_LINE_06 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier6_&year_data;
  CREATE TABLE WORK.RefCarrier6_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2012.BCARRIER_CLAIMS_06 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier6_&year_data;
	CREATE TABLE WORK.OpRefCarrier6_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier6_&year_data AS a
	LEFT JOIN WORK.RefCarrier6_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* July */
PROC SQL;
  DROP TABLE WORK.OpCarrier7_&year_data;
  CREATE TABLE WORK.OpCarrier7_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2012.BCARRIER_LINE_07 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier7_&year_data;
  CREATE TABLE WORK.RefCarrier7_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2012.BCARRIER_CLAIMS_07 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier7_&year_data;
	CREATE TABLE WORK.OpRefCarrier7_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier7_&year_data AS a
	LEFT JOIN WORK.RefCarrier7_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* August */
PROC SQL;
  DROP TABLE WORK.OpCarrier8_&year_data;
  CREATE TABLE WORK.OpCarrier8_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2012.BCARRIER_LINE_08 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier8_&year_data;
  CREATE TABLE WORK.RefCarrier8_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2012.BCARRIER_CLAIMS_08 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier8_&year_data;
	CREATE TABLE WORK.OpRefCarrier8_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier8_&year_data AS a
	LEFT JOIN WORK.RefCarrier8_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* September */
PROC SQL;
  DROP TABLE WORK.OpCarrier9_&year_data;
  CREATE TABLE WORK.OpCarrier9_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2012.BCARRIER_LINE_09 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier9_&year_data;
  CREATE TABLE WORK.RefCarrier9_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2012.BCARRIER_CLAIMS_09 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier9_&year_data;
	CREATE TABLE WORK.OpRefCarrier9_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier9_&year_data AS a
	LEFT JOIN WORK.RefCarrier9_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* October */
PROC SQL;
  DROP TABLE WORK.OpCarrier10_&year_data;
  CREATE TABLE WORK.OpCarrier10_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2012.BCARRIER_LINE_10 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier10_&year_data;
  CREATE TABLE WORK.RefCarrier10_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2012.BCARRIER_CLAIMS_10 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier10_&year_data;
	CREATE TABLE WORK.OpRefCarrier10_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier10_&year_data AS a
	LEFT JOIN WORK.RefCarrier10_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* November */
PROC SQL;
  DROP TABLE WORK.OpCarrier11_&year_data;
  CREATE TABLE WORK.OpCarrier11_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2012.BCARRIER_LINE_11 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier11_&year_data;
  CREATE TABLE WORK.RefCarrier11_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2012.BCARRIER_CLAIMS_11 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier11_&year_data;
	CREATE TABLE WORK.OpRefCarrier11_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier11_&year_data AS a
	LEFT JOIN WORK.RefCarrier11_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* December */
PROC SQL;
  DROP TABLE WORK.OpCarrier12_&year_data;
  CREATE TABLE WORK.OpCarrier12_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2012.BCARRIER_LINE_12 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier12_&year_data;
  CREATE TABLE WORK.RefCarrier12_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2012.BCARRIER_CLAIMS_12 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier12_&year_data;
	CREATE TABLE WORK.OpRefCarrier12_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier12_&year_data AS a
	LEFT JOIN WORK.RefCarrier12_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;


/* Append all months */
DATA IMC969SL.ReferralsCarrier_&year_data;
	SET	WORK.OpRefCarrier1_&year_data
  		WORK.OpRefCarrier2_&year_data
		WORK.OpRefCarrier3_&year_data
		WORK.OpRefCarrier4_&year_data
		WORK.OpRefCarrier5_&year_data
		WORK.OpRefCarrier6_&year_data
		WORK.OpRefCarrier7_&year_data
		WORK.OpRefCarrier8_&year_data
		WORK.OpRefCarrier9_&year_data
		WORK.OpRefCarrier10_&year_data
		WORK.OpRefCarrier11_&year_data
		WORK.OpRefCarrier12_&year_data;
RUN;







%LET year_data=2013;
/* Identify unique inpatient stays */
PROC SQL;
	DROP TABLE WORK.Unique_Stays;
	CREATE TABLE WORK.Unique_Stays AS
	SELECT DISTINCT BENE_ID, CLM_FROM_DT, CLM_THRU_DT, OP_PHYSN_NPI
	FROM IMC969SL.MajorJoint_&year_data
	GROUP BY BENE_ID, CLM_FROM_DT, OP_PHYSN_NPI;
QUIT;



/* January */
PROC SQL;
  DROP TABLE WORK.OpCarrier1_&year_data;
  CREATE TABLE WORK.OpCarrier1_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2013.BCARRIER_LINE_01 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier1_&year_data;
  CREATE TABLE WORK.RefCarrier1_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2013.BCARRIER_CLAIMS_01 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier1_&year_data;
	CREATE TABLE WORK.OpRefCarrier1_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier1_&year_data AS a
	LEFT JOIN WORK.RefCarrier1_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* February */
PROC SQL;
  DROP TABLE WORK.OpCarrier2_&year_data;
  CREATE TABLE WORK.OpCarrier2_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2013.BCARRIER_LINE_02 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier2_&year_data;
  CREATE TABLE WORK.RefCarrier2_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2013.BCARRIER_CLAIMS_02 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier2_&year_data;
	CREATE TABLE WORK.OpRefCarrier2_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier2_&year_data AS a
	LEFT JOIN WORK.RefCarrier2_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* March */
PROC SQL;
  DROP TABLE WORK.OpCarrier3_&year_data;
  CREATE TABLE WORK.OpCarrier3_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2013.BCARRIER_LINE_03 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier3_&year_data;
  CREATE TABLE WORK.RefCarrier3_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2013.BCARRIER_CLAIMS_03 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier3_&year_data;
	CREATE TABLE WORK.OpRefCarrier3_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier3_&year_data AS a
	LEFT JOIN WORK.RefCarrier3_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* April */
PROC SQL;
  DROP TABLE WORK.OpCarrier4_&year_data;
  CREATE TABLE WORK.OpCarrier4_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2013.BCARRIER_LINE_04 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier4_&year_data;
  CREATE TABLE WORK.RefCarrier4_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2013.BCARRIER_CLAIMS_04 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier4_&year_data;
	CREATE TABLE WORK.OpRefCarrier4_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier4_&year_data AS a
	LEFT JOIN WORK.RefCarrier4_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* May */
PROC SQL;
  DROP TABLE WORK.OpCarrier5_&year_data;
  CREATE TABLE WORK.OpCarrier5_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2013.BCARRIER_LINE_05 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier5_&year_data;
  CREATE TABLE WORK.RefCarrier5_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2013.BCARRIER_CLAIMS_05 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier5_&year_data;
	CREATE TABLE WORK.OpRefCarrier5_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier5_&year_data AS a
	LEFT JOIN WORK.RefCarrier5_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* June */
PROC SQL;
  DROP TABLE WORK.OpCarrier6_&year_data;
  CREATE TABLE WORK.OpCarrier6_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2013.BCARRIER_LINE_06 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier6_&year_data;
  CREATE TABLE WORK.RefCarrier6_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2013.BCARRIER_CLAIMS_06 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier6_&year_data;
	CREATE TABLE WORK.OpRefCarrier6_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier6_&year_data AS a
	LEFT JOIN WORK.RefCarrier6_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* July */
PROC SQL;
  DROP TABLE WORK.OpCarrier7_&year_data;
  CREATE TABLE WORK.OpCarrier7_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2013.BCARRIER_LINE_07 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier7_&year_data;
  CREATE TABLE WORK.RefCarrier7_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2013.BCARRIER_CLAIMS_07 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier7_&year_data;
	CREATE TABLE WORK.OpRefCarrier7_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier7_&year_data AS a
	LEFT JOIN WORK.RefCarrier7_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* August */
PROC SQL;
  DROP TABLE WORK.OpCarrier8_&year_data;
  CREATE TABLE WORK.OpCarrier8_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2013.BCARRIER_LINE_08 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier8_&year_data;
  CREATE TABLE WORK.RefCarrier8_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2013.BCARRIER_CLAIMS_08 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier8_&year_data;
	CREATE TABLE WORK.OpRefCarrier8_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier8_&year_data AS a
	LEFT JOIN WORK.RefCarrier8_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* September */
PROC SQL;
  DROP TABLE WORK.OpCarrier9_&year_data;
  CREATE TABLE WORK.OpCarrier9_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2013.BCARRIER_LINE_09 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier9_&year_data;
  CREATE TABLE WORK.RefCarrier9_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2013.BCARRIER_CLAIMS_09 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier9_&year_data;
	CREATE TABLE WORK.OpRefCarrier9_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier9_&year_data AS a
	LEFT JOIN WORK.RefCarrier9_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* October */
PROC SQL;
  DROP TABLE WORK.OpCarrier10_&year_data;
  CREATE TABLE WORK.OpCarrier10_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2013.BCARRIER_LINE_10 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier10_&year_data;
  CREATE TABLE WORK.RefCarrier10_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2013.BCARRIER_CLAIMS_10 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier10_&year_data;
	CREATE TABLE WORK.OpRefCarrier10_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier10_&year_data AS a
	LEFT JOIN WORK.RefCarrier10_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* November */
PROC SQL;
  DROP TABLE WORK.OpCarrier11_&year_data;
  CREATE TABLE WORK.OpCarrier11_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2013.BCARRIER_LINE_11 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier11_&year_data;
  CREATE TABLE WORK.RefCarrier11_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2013.BCARRIER_CLAIMS_11 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier11_&year_data;
	CREATE TABLE WORK.OpRefCarrier11_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier11_&year_data AS a
	LEFT JOIN WORK.RefCarrier11_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* December */
PROC SQL;
  DROP TABLE WORK.OpCarrier12_&year_data;
  CREATE TABLE WORK.OpCarrier12_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2013.BCARRIER_LINE_12 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier12_&year_data;
  CREATE TABLE WORK.RefCarrier12_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2013.BCARRIER_CLAIMS_12 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier12_&year_data;
	CREATE TABLE WORK.OpRefCarrier12_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier12_&year_data AS a
	LEFT JOIN WORK.RefCarrier12_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;


/* Append all months */
DATA IMC969SL.ReferralsCarrier_&year_data;
	SET	WORK.OpRefCarrier1_&year_data
  		WORK.OpRefCarrier2_&year_data
		WORK.OpRefCarrier3_&year_data
		WORK.OpRefCarrier4_&year_data
		WORK.OpRefCarrier5_&year_data
		WORK.OpRefCarrier6_&year_data
		WORK.OpRefCarrier7_&year_data
		WORK.OpRefCarrier8_&year_data
		WORK.OpRefCarrier9_&year_data
		WORK.OpRefCarrier10_&year_data
		WORK.OpRefCarrier11_&year_data
		WORK.OpRefCarrier12_&year_data;
RUN;








%LET year_data=2014;
/* Identify unique inpatient stays */
PROC SQL;
	DROP TABLE WORK.Unique_Stays;
	CREATE TABLE WORK.Unique_Stays AS
	SELECT DISTINCT BENE_ID, CLM_FROM_DT, CLM_THRU_DT, OP_PHYSN_NPI
	FROM IMC969SL.MajorJoint_&year_data
	GROUP BY BENE_ID, CLM_FROM_DT, OP_PHYSN_NPI;
QUIT;



/* January */
PROC SQL;
  DROP TABLE WORK.OpCarrier1_&year_data;
  CREATE TABLE WORK.OpCarrier1_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2014.BCARRIER_LINE_01 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier1_&year_data;
  CREATE TABLE WORK.RefCarrier1_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2014.BCARRIER_CLAIMS_01 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier1_&year_data;
	CREATE TABLE WORK.OpRefCarrier1_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier1_&year_data AS a
	LEFT JOIN WORK.RefCarrier1_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* February */
PROC SQL;
  DROP TABLE WORK.OpCarrier2_&year_data;
  CREATE TABLE WORK.OpCarrier2_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2014.BCARRIER_LINE_02 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier2_&year_data;
  CREATE TABLE WORK.RefCarrier2_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2014.BCARRIER_CLAIMS_02 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier2_&year_data;
	CREATE TABLE WORK.OpRefCarrier2_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier2_&year_data AS a
	LEFT JOIN WORK.RefCarrier2_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* March */
PROC SQL;
  DROP TABLE WORK.OpCarrier3_&year_data;
  CREATE TABLE WORK.OpCarrier3_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2014.BCARRIER_LINE_03 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier3_&year_data;
  CREATE TABLE WORK.RefCarrier3_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2014.BCARRIER_CLAIMS_03 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier3_&year_data;
	CREATE TABLE WORK.OpRefCarrier3_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier3_&year_data AS a
	LEFT JOIN WORK.RefCarrier3_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* April */
PROC SQL;
  DROP TABLE WORK.OpCarrier4_&year_data;
  CREATE TABLE WORK.OpCarrier4_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2014.BCARRIER_LINE_04 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier4_&year_data;
  CREATE TABLE WORK.RefCarrier4_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2014.BCARRIER_CLAIMS_04 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier4_&year_data;
	CREATE TABLE WORK.OpRefCarrier4_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier4_&year_data AS a
	LEFT JOIN WORK.RefCarrier4_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* May */
PROC SQL;
  DROP TABLE WORK.OpCarrier5_&year_data;
  CREATE TABLE WORK.OpCarrier5_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2014.BCARRIER_LINE_05 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier5_&year_data;
  CREATE TABLE WORK.RefCarrier5_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2014.BCARRIER_CLAIMS_05 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier5_&year_data;
	CREATE TABLE WORK.OpRefCarrier5_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier5_&year_data AS a
	LEFT JOIN WORK.RefCarrier5_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* June */
PROC SQL;
  DROP TABLE WORK.OpCarrier6_&year_data;
  CREATE TABLE WORK.OpCarrier6_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2014.BCARRIER_LINE_06 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier6_&year_data;
  CREATE TABLE WORK.RefCarrier6_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2014.BCARRIER_CLAIMS_06 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier6_&year_data;
	CREATE TABLE WORK.OpRefCarrier6_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier6_&year_data AS a
	LEFT JOIN WORK.RefCarrier6_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* July */
PROC SQL;
  DROP TABLE WORK.OpCarrier7_&year_data;
  CREATE TABLE WORK.OpCarrier7_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2014.BCARRIER_LINE_07 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier7_&year_data;
  CREATE TABLE WORK.RefCarrier7_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2014.BCARRIER_CLAIMS_07 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier7_&year_data;
	CREATE TABLE WORK.OpRefCarrier7_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier7_&year_data AS a
	LEFT JOIN WORK.RefCarrier7_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* August */
PROC SQL;
  DROP TABLE WORK.OpCarrier8_&year_data;
  CREATE TABLE WORK.OpCarrier8_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2014.BCARRIER_LINE_08 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier8_&year_data;
  CREATE TABLE WORK.RefCarrier8_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2014.BCARRIER_CLAIMS_08 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier8_&year_data;
	CREATE TABLE WORK.OpRefCarrier8_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier8_&year_data AS a
	LEFT JOIN WORK.RefCarrier8_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* September */
PROC SQL;
  DROP TABLE WORK.OpCarrier9_&year_data;
  CREATE TABLE WORK.OpCarrier9_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2014.BCARRIER_LINE_09 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier9_&year_data;
  CREATE TABLE WORK.RefCarrier9_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2014.BCARRIER_CLAIMS_09 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier9_&year_data;
	CREATE TABLE WORK.OpRefCarrier9_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier9_&year_data AS a
	LEFT JOIN WORK.RefCarrier9_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* October */
PROC SQL;
  DROP TABLE WORK.OpCarrier10_&year_data;
  CREATE TABLE WORK.OpCarrier10_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2014.BCARRIER_LINE_10 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier10_&year_data;
  CREATE TABLE WORK.RefCarrier10_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2014.BCARRIER_CLAIMS_10 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier10_&year_data;
	CREATE TABLE WORK.OpRefCarrier10_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier10_&year_data AS a
	LEFT JOIN WORK.RefCarrier10_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* November */
PROC SQL;
  DROP TABLE WORK.OpCarrier11_&year_data;
  CREATE TABLE WORK.OpCarrier11_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2014.BCARRIER_LINE_11 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier11_&year_data;
  CREATE TABLE WORK.RefCarrier11_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2014.BCARRIER_CLAIMS_11 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier11_&year_data;
	CREATE TABLE WORK.OpRefCarrier11_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier11_&year_data AS a
	LEFT JOIN WORK.RefCarrier11_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* December */
PROC SQL;
  DROP TABLE WORK.OpCarrier12_&year_data;
  CREATE TABLE WORK.OpCarrier12_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2014.BCARRIER_LINE_12 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier12_&year_data;
  CREATE TABLE WORK.RefCarrier12_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2014.BCARRIER_CLAIMS_12 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier12_&year_data;
	CREATE TABLE WORK.OpRefCarrier12_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier12_&year_data AS a
	LEFT JOIN WORK.RefCarrier12_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;


/* Append all months */
DATA IMC969SL.ReferralsCarrier_&year_data;
	SET	WORK.OpRefCarrier1_&year_data
  		WORK.OpRefCarrier2_&year_data
		WORK.OpRefCarrier3_&year_data
		WORK.OpRefCarrier4_&year_data
		WORK.OpRefCarrier5_&year_data
		WORK.OpRefCarrier6_&year_data
		WORK.OpRefCarrier7_&year_data
		WORK.OpRefCarrier8_&year_data
		WORK.OpRefCarrier9_&year_data
		WORK.OpRefCarrier10_&year_data
		WORK.OpRefCarrier11_&year_data
		WORK.OpRefCarrier12_&year_data;
RUN;






%LET year_data=2015;
/* Identify unique inpatient stays */
PROC SQL;
	DROP TABLE WORK.Unique_Stays;
	CREATE TABLE WORK.Unique_Stays AS
	SELECT DISTINCT BENE_ID, CLM_FROM_DT, CLM_THRU_DT, OP_PHYSN_NPI
	FROM IMC969SL.MajorJoint_&year_data
	GROUP BY BENE_ID, CLM_FROM_DT, OP_PHYSN_NPI;
QUIT;



/* January */
PROC SQL;
  DROP TABLE WORK.OpCarrier1_&year_data;
  CREATE TABLE WORK.OpCarrier1_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2015.BCARRIER_LINE_01 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier1_&year_data;
  CREATE TABLE WORK.RefCarrier1_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2015.BCARRIER_CLAIMS_01 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier1_&year_data;
	CREATE TABLE WORK.OpRefCarrier1_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier1_&year_data AS a
	LEFT JOIN WORK.RefCarrier1_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* February */
PROC SQL;
  DROP TABLE WORK.OpCarrier2_&year_data;
  CREATE TABLE WORK.OpCarrier2_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2015.BCARRIER_LINE_02 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier2_&year_data;
  CREATE TABLE WORK.RefCarrier2_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2015.BCARRIER_CLAIMS_02 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier2_&year_data;
	CREATE TABLE WORK.OpRefCarrier2_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier2_&year_data AS a
	LEFT JOIN WORK.RefCarrier2_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* March */
PROC SQL;
  DROP TABLE WORK.OpCarrier3_&year_data;
  CREATE TABLE WORK.OpCarrier3_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2015.BCARRIER_LINE_03 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier3_&year_data;
  CREATE TABLE WORK.RefCarrier3_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2015.BCARRIER_CLAIMS_03 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier3_&year_data;
	CREATE TABLE WORK.OpRefCarrier3_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier3_&year_data AS a
	LEFT JOIN WORK.RefCarrier3_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* April */
PROC SQL;
  DROP TABLE WORK.OpCarrier4_&year_data;
  CREATE TABLE WORK.OpCarrier4_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2015.BCARRIER_LINE_04 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier4_&year_data;
  CREATE TABLE WORK.RefCarrier4_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2015.BCARRIER_CLAIMS_04 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier4_&year_data;
	CREATE TABLE WORK.OpRefCarrier4_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier4_&year_data AS a
	LEFT JOIN WORK.RefCarrier4_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* May */
PROC SQL;
  DROP TABLE WORK.OpCarrier5_&year_data;
  CREATE TABLE WORK.OpCarrier5_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2015.BCARRIER_LINE_05 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier5_&year_data;
  CREATE TABLE WORK.RefCarrier5_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2015.BCARRIER_CLAIMS_05 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier5_&year_data;
	CREATE TABLE WORK.OpRefCarrier5_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier5_&year_data AS a
	LEFT JOIN WORK.RefCarrier5_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* June */
PROC SQL;
  DROP TABLE WORK.OpCarrier6_&year_data;
  CREATE TABLE WORK.OpCarrier6_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2015.BCARRIER_LINE_06 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier6_&year_data;
  CREATE TABLE WORK.RefCarrier6_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2015.BCARRIER_CLAIMS_06 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier6_&year_data;
	CREATE TABLE WORK.OpRefCarrier6_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier6_&year_data AS a
	LEFT JOIN WORK.RefCarrier6_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* July */
PROC SQL;
  DROP TABLE WORK.OpCarrier7_&year_data;
  CREATE TABLE WORK.OpCarrier7_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2015.BCARRIER_LINE_07 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier7_&year_data;
  CREATE TABLE WORK.RefCarrier7_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2015.BCARRIER_CLAIMS_07 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier7_&year_data;
	CREATE TABLE WORK.OpRefCarrier7_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier7_&year_data AS a
	LEFT JOIN WORK.RefCarrier7_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* August */
PROC SQL;
  DROP TABLE WORK.OpCarrier8_&year_data;
  CREATE TABLE WORK.OpCarrier8_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2015.BCARRIER_LINE_08 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier8_&year_data;
  CREATE TABLE WORK.RefCarrier8_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2015.BCARRIER_CLAIMS_08 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier8_&year_data;
	CREATE TABLE WORK.OpRefCarrier8_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier8_&year_data AS a
	LEFT JOIN WORK.RefCarrier8_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* September */
PROC SQL;
  DROP TABLE WORK.OpCarrier9_&year_data;
  CREATE TABLE WORK.OpCarrier9_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2015.BCARRIER_LINE_09 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier9_&year_data;
  CREATE TABLE WORK.RefCarrier9_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2015.BCARRIER_CLAIMS_09 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier9_&year_data;
	CREATE TABLE WORK.OpRefCarrier9_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier9_&year_data AS a
	LEFT JOIN WORK.RefCarrier9_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* October */
PROC SQL;
  DROP TABLE WORK.OpCarrier10_&year_data;
  CREATE TABLE WORK.OpCarrier10_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2015.BCARRIER_LINE_10 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier10_&year_data;
  CREATE TABLE WORK.RefCarrier10_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2015.BCARRIER_CLAIMS_10 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier10_&year_data;
	CREATE TABLE WORK.OpRefCarrier10_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier10_&year_data AS a
	LEFT JOIN WORK.RefCarrier10_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* November */
PROC SQL;
  DROP TABLE WORK.OpCarrier11_&year_data;
  CREATE TABLE WORK.OpCarrier11_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2015.BCARRIER_LINE_11 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier11_&year_data;
  CREATE TABLE WORK.RefCarrier11_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2015.BCARRIER_CLAIMS_11 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier11_&year_data;
	CREATE TABLE WORK.OpRefCarrier11_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier11_&year_data AS a
	LEFT JOIN WORK.RefCarrier11_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* December */
PROC SQL;
  DROP TABLE WORK.OpCarrier12_&year_data;
  CREATE TABLE WORK.OpCarrier12_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2015.BCARRIER_LINE_12 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier12_&year_data;
  CREATE TABLE WORK.RefCarrier12_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2015.BCARRIER_CLAIMS_12 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier12_&year_data;
	CREATE TABLE WORK.OpRefCarrier12_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier12_&year_data AS a
	LEFT JOIN WORK.RefCarrier12_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;


/* Append all months */
DATA IMC969SL.ReferralsCarrier_&year_data;
	SET	WORK.OpRefCarrier1_&year_data
  		WORK.OpRefCarrier2_&year_data
		WORK.OpRefCarrier3_&year_data
		WORK.OpRefCarrier4_&year_data
		WORK.OpRefCarrier5_&year_data
		WORK.OpRefCarrier6_&year_data
		WORK.OpRefCarrier7_&year_data
		WORK.OpRefCarrier8_&year_data
		WORK.OpRefCarrier9_&year_data
		WORK.OpRefCarrier10_&year_data
		WORK.OpRefCarrier11_&year_data
		WORK.OpRefCarrier12_&year_data;
RUN;







%LET year_data=2016;
/* Identify unique inpatient stays */
PROC SQL;
	DROP TABLE WORK.Unique_Stays;
	CREATE TABLE WORK.Unique_Stays AS
	SELECT DISTINCT BENE_ID, CLM_FROM_DT, CLM_THRU_DT, OP_PHYSN_NPI
	FROM IMC969SL.MajorJoint_&year_data
	GROUP BY BENE_ID, CLM_FROM_DT, OP_PHYSN_NPI;
QUIT;



/* January */
PROC SQL;
  DROP TABLE WORK.OpCarrier1_&year_data;
  CREATE TABLE WORK.OpCarrier1_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2016.BCARRIER_LINE_01 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier1_&year_data;
  CREATE TABLE WORK.RefCarrier1_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2016.BCARRIER_CLAIMS_01 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier1_&year_data;
	CREATE TABLE WORK.OpRefCarrier1_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier1_&year_data AS a
	LEFT JOIN WORK.RefCarrier1_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* February */
PROC SQL;
  DROP TABLE WORK.OpCarrier2_&year_data;
  CREATE TABLE WORK.OpCarrier2_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2016.BCARRIER_LINE_02 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier2_&year_data;
  CREATE TABLE WORK.RefCarrier2_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2016.BCARRIER_CLAIMS_02 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier2_&year_data;
	CREATE TABLE WORK.OpRefCarrier2_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier2_&year_data AS a
	LEFT JOIN WORK.RefCarrier2_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* March */
PROC SQL;
  DROP TABLE WORK.OpCarrier3_&year_data;
  CREATE TABLE WORK.OpCarrier3_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2016.BCARRIER_LINE_03 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier3_&year_data;
  CREATE TABLE WORK.RefCarrier3_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2016.BCARRIER_CLAIMS_03 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier3_&year_data;
	CREATE TABLE WORK.OpRefCarrier3_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier3_&year_data AS a
	LEFT JOIN WORK.RefCarrier3_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* April */
PROC SQL;
  DROP TABLE WORK.OpCarrier4_&year_data;
  CREATE TABLE WORK.OpCarrier4_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2016.BCARRIER_LINE_04 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier4_&year_data;
  CREATE TABLE WORK.RefCarrier4_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2016.BCARRIER_CLAIMS_04 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier4_&year_data;
	CREATE TABLE WORK.OpRefCarrier4_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier4_&year_data AS a
	LEFT JOIN WORK.RefCarrier4_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* May */
PROC SQL;
  DROP TABLE WORK.OpCarrier5_&year_data;
  CREATE TABLE WORK.OpCarrier5_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2016.BCARRIER_LINE_05 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier5_&year_data;
  CREATE TABLE WORK.RefCarrier5_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2016.BCARRIER_CLAIMS_05 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier5_&year_data;
	CREATE TABLE WORK.OpRefCarrier5_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier5_&year_data AS a
	LEFT JOIN WORK.RefCarrier5_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* June */
PROC SQL;
  DROP TABLE WORK.OpCarrier6_&year_data;
  CREATE TABLE WORK.OpCarrier6_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2016.BCARRIER_LINE_06 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier6_&year_data;
  CREATE TABLE WORK.RefCarrier6_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2016.BCARRIER_CLAIMS_06 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier6_&year_data;
	CREATE TABLE WORK.OpRefCarrier6_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier6_&year_data AS a
	LEFT JOIN WORK.RefCarrier6_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* July */
PROC SQL;
  DROP TABLE WORK.OpCarrier7_&year_data;
  CREATE TABLE WORK.OpCarrier7_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2016.BCARRIER_LINE_07 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier7_&year_data;
  CREATE TABLE WORK.RefCarrier7_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2016.BCARRIER_CLAIMS_07 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier7_&year_data;
	CREATE TABLE WORK.OpRefCarrier7_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier7_&year_data AS a
	LEFT JOIN WORK.RefCarrier7_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* August */
PROC SQL;
  DROP TABLE WORK.OpCarrier8_&year_data;
  CREATE TABLE WORK.OpCarrier8_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2016.BCARRIER_LINE_08 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier8_&year_data;
  CREATE TABLE WORK.RefCarrier8_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2016.BCARRIER_CLAIMS_08 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier8_&year_data;
	CREATE TABLE WORK.OpRefCarrier8_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier8_&year_data AS a
	LEFT JOIN WORK.RefCarrier8_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* September */
PROC SQL;
  DROP TABLE WORK.OpCarrier9_&year_data;
  CREATE TABLE WORK.OpCarrier9_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2016.BCARRIER_LINE_09 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier9_&year_data;
  CREATE TABLE WORK.RefCarrier9_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2016.BCARRIER_CLAIMS_09 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier9_&year_data;
	CREATE TABLE WORK.OpRefCarrier9_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier9_&year_data AS a
	LEFT JOIN WORK.RefCarrier9_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* October */
PROC SQL;
  DROP TABLE WORK.OpCarrier10_&year_data;
  CREATE TABLE WORK.OpCarrier10_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2016.BCARRIER_LINE_10 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier10_&year_data;
  CREATE TABLE WORK.RefCarrier10_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2016.BCARRIER_CLAIMS_10 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier10_&year_data;
	CREATE TABLE WORK.OpRefCarrier10_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier10_&year_data AS a
	LEFT JOIN WORK.RefCarrier10_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* November */
PROC SQL;
  DROP TABLE WORK.OpCarrier11_&year_data;
  CREATE TABLE WORK.OpCarrier11_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2016.BCARRIER_LINE_11 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier11_&year_data;
  CREATE TABLE WORK.RefCarrier11_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2016.BCARRIER_CLAIMS_11 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier11_&year_data;
	CREATE TABLE WORK.OpRefCarrier11_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier11_&year_data AS a
	LEFT JOIN WORK.RefCarrier11_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* December */
PROC SQL;
  DROP TABLE WORK.OpCarrier12_&year_data;
  CREATE TABLE WORK.OpCarrier12_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2016.BCARRIER_LINE_12 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier12_&year_data;
  CREATE TABLE WORK.RefCarrier12_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2016.BCARRIER_CLAIMS_12 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier12_&year_data;
	CREATE TABLE WORK.OpRefCarrier12_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier12_&year_data AS a
	LEFT JOIN WORK.RefCarrier12_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;


/* Append all months */
DATA IMC969SL.ReferralsCarrier_&year_data;
	SET	WORK.OpRefCarrier1_&year_data
  		WORK.OpRefCarrier2_&year_data
		WORK.OpRefCarrier3_&year_data
		WORK.OpRefCarrier4_&year_data
		WORK.OpRefCarrier5_&year_data
		WORK.OpRefCarrier6_&year_data
		WORK.OpRefCarrier7_&year_data
		WORK.OpRefCarrier8_&year_data
		WORK.OpRefCarrier9_&year_data
		WORK.OpRefCarrier10_&year_data
		WORK.OpRefCarrier11_&year_data
		WORK.OpRefCarrier12_&year_data;
RUN;






%LET year_data=2017;
/* Identify unique inpatient stays */
PROC SQL;
	DROP TABLE WORK.Unique_Stays;
	CREATE TABLE WORK.Unique_Stays AS
	SELECT DISTINCT BENE_ID, CLM_FROM_DT, CLM_THRU_DT, OP_PHYSN_NPI
	FROM IMC969SL.MajorJoint_&year_data
	GROUP BY BENE_ID, CLM_FROM_DT, OP_PHYSN_NPI;
QUIT;



/* January */
PROC SQL;
  DROP TABLE WORK.OpCarrier1_&year_data;
  CREATE TABLE WORK.OpCarrier1_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2017.BCARRIER_LINE_01 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier1_&year_data;
  CREATE TABLE WORK.RefCarrier1_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2017.BCARRIER_CLAIMS_01 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier1_&year_data;
	CREATE TABLE WORK.OpRefCarrier1_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier1_&year_data AS a
	LEFT JOIN WORK.RefCarrier1_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* February */
PROC SQL;
  DROP TABLE WORK.OpCarrier2_&year_data;
  CREATE TABLE WORK.OpCarrier2_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2017.BCARRIER_LINE_02 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier2_&year_data;
  CREATE TABLE WORK.RefCarrier2_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2017.BCARRIER_CLAIMS_02 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier2_&year_data;
	CREATE TABLE WORK.OpRefCarrier2_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier2_&year_data AS a
	LEFT JOIN WORK.RefCarrier2_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* March */
PROC SQL;
  DROP TABLE WORK.OpCarrier3_&year_data;
  CREATE TABLE WORK.OpCarrier3_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2017.BCARRIER_LINE_03 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier3_&year_data;
  CREATE TABLE WORK.RefCarrier3_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2017.BCARRIER_CLAIMS_03 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier3_&year_data;
	CREATE TABLE WORK.OpRefCarrier3_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier3_&year_data AS a
	LEFT JOIN WORK.RefCarrier3_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* April */
PROC SQL;
  DROP TABLE WORK.OpCarrier4_&year_data;
  CREATE TABLE WORK.OpCarrier4_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2017.BCARRIER_LINE_04 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier4_&year_data;
  CREATE TABLE WORK.RefCarrier4_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2017.BCARRIER_CLAIMS_04 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier4_&year_data;
	CREATE TABLE WORK.OpRefCarrier4_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier4_&year_data AS a
	LEFT JOIN WORK.RefCarrier4_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* May */
PROC SQL;
  DROP TABLE WORK.OpCarrier5_&year_data;
  CREATE TABLE WORK.OpCarrier5_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2017.BCARRIER_LINE_05 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier5_&year_data;
  CREATE TABLE WORK.RefCarrier5_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2017.BCARRIER_CLAIMS_05 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier5_&year_data;
	CREATE TABLE WORK.OpRefCarrier5_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier5_&year_data AS a
	LEFT JOIN WORK.RefCarrier5_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* June */
PROC SQL;
  DROP TABLE WORK.OpCarrier6_&year_data;
  CREATE TABLE WORK.OpCarrier6_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2017.BCARRIER_LINE_06 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier6_&year_data;
  CREATE TABLE WORK.RefCarrier6_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2017.BCARRIER_CLAIMS_06 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier6_&year_data;
	CREATE TABLE WORK.OpRefCarrier6_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier6_&year_data AS a
	LEFT JOIN WORK.RefCarrier6_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* July */
PROC SQL;
  DROP TABLE WORK.OpCarrier7_&year_data;
  CREATE TABLE WORK.OpCarrier7_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2017.BCARRIER_LINE_07 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier7_&year_data;
  CREATE TABLE WORK.RefCarrier7_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2017.BCARRIER_CLAIMS_07 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier7_&year_data;
	CREATE TABLE WORK.OpRefCarrier7_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier7_&year_data AS a
	LEFT JOIN WORK.RefCarrier7_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* August */
PROC SQL;
  DROP TABLE WORK.OpCarrier8_&year_data;
  CREATE TABLE WORK.OpCarrier8_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2017.BCARRIER_LINE_08 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier8_&year_data;
  CREATE TABLE WORK.RefCarrier8_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2017.BCARRIER_CLAIMS_08 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier8_&year_data;
	CREATE TABLE WORK.OpRefCarrier8_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier8_&year_data AS a
	LEFT JOIN WORK.RefCarrier8_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* September */
PROC SQL;
  DROP TABLE WORK.OpCarrier9_&year_data;
  CREATE TABLE WORK.OpCarrier9_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2017.BCARRIER_LINE_09 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier9_&year_data;
  CREATE TABLE WORK.RefCarrier9_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2017.BCARRIER_CLAIMS_09 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier9_&year_data;
	CREATE TABLE WORK.OpRefCarrier9_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier9_&year_data AS a
	LEFT JOIN WORK.RefCarrier9_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* October */
PROC SQL;
  DROP TABLE WORK.OpCarrier10_&year_data;
  CREATE TABLE WORK.OpCarrier10_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2017.BCARRIER_LINE_10 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier10_&year_data;
  CREATE TABLE WORK.RefCarrier10_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2017.BCARRIER_CLAIMS_10 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier10_&year_data;
	CREATE TABLE WORK.OpRefCarrier10_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier10_&year_data AS a
	LEFT JOIN WORK.RefCarrier10_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* November */
PROC SQL;
  DROP TABLE WORK.OpCarrier11_&year_data;
  CREATE TABLE WORK.OpCarrier11_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2017.BCARRIER_LINE_11 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier11_&year_data;
  CREATE TABLE WORK.RefCarrier11_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2017.BCARRIER_CLAIMS_11 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier11_&year_data;
	CREATE TABLE WORK.OpRefCarrier11_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier11_&year_data AS a
	LEFT JOIN WORK.RefCarrier11_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* December */
PROC SQL;
  DROP TABLE WORK.OpCarrier12_&year_data;
  CREATE TABLE WORK.OpCarrier12_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2017.BCARRIER_LINE_12 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier12_&year_data;
  CREATE TABLE WORK.RefCarrier12_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2017.BCARRIER_CLAIMS_12 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier12_&year_data;
	CREATE TABLE WORK.OpRefCarrier12_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier12_&year_data AS a
	LEFT JOIN WORK.RefCarrier12_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;


/* Append all months */
DATA IMC969SL.ReferralsCarrier_&year_data;
	SET	WORK.OpRefCarrier1_&year_data
  		WORK.OpRefCarrier2_&year_data
		WORK.OpRefCarrier3_&year_data
		WORK.OpRefCarrier4_&year_data
		WORK.OpRefCarrier5_&year_data
		WORK.OpRefCarrier6_&year_data
		WORK.OpRefCarrier7_&year_data
		WORK.OpRefCarrier8_&year_data
		WORK.OpRefCarrier9_&year_data
		WORK.OpRefCarrier10_&year_data
		WORK.OpRefCarrier11_&year_data
		WORK.OpRefCarrier12_&year_data;
RUN;





%LET year_data=2018;
/* Identify unique inpatient stays */
PROC SQL;
	DROP TABLE WORK.Unique_Stays;
	CREATE TABLE WORK.Unique_Stays AS
	SELECT DISTINCT BENE_ID, CLM_FROM_DT, CLM_THRU_DT, OP_PHYSN_NPI
	FROM IMC969SL.MajorJoint_&year_data
	GROUP BY BENE_ID, CLM_FROM_DT, OP_PHYSN_NPI;
QUIT;



/* January */
PROC SQL;
  DROP TABLE WORK.OpCarrier1_&year_data;
  CREATE TABLE WORK.OpCarrier1_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2018.BCARRIER_LINE_01 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier1_&year_data;
  CREATE TABLE WORK.RefCarrier1_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2018.BCARRIER_CLAIMS_01 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier1_&year_data;
	CREATE TABLE WORK.OpRefCarrier1_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier1_&year_data AS a
	LEFT JOIN WORK.RefCarrier1_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* February */
PROC SQL;
  DROP TABLE WORK.OpCarrier2_&year_data;
  CREATE TABLE WORK.OpCarrier2_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2018.BCARRIER_LINE_02 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier2_&year_data;
  CREATE TABLE WORK.RefCarrier2_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2018.BCARRIER_CLAIMS_02 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier2_&year_data;
	CREATE TABLE WORK.OpRefCarrier2_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier2_&year_data AS a
	LEFT JOIN WORK.RefCarrier2_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* March */
PROC SQL;
  DROP TABLE WORK.OpCarrier3_&year_data;
  CREATE TABLE WORK.OpCarrier3_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2018.BCARRIER_LINE_03 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier3_&year_data;
  CREATE TABLE WORK.RefCarrier3_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2018.BCARRIER_CLAIMS_03 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier3_&year_data;
	CREATE TABLE WORK.OpRefCarrier3_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier3_&year_data AS a
	LEFT JOIN WORK.RefCarrier3_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* April */
PROC SQL;
  DROP TABLE WORK.OpCarrier4_&year_data;
  CREATE TABLE WORK.OpCarrier4_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2018.BCARRIER_LINE_04 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier4_&year_data;
  CREATE TABLE WORK.RefCarrier4_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2018.BCARRIER_CLAIMS_04 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier4_&year_data;
	CREATE TABLE WORK.OpRefCarrier4_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier4_&year_data AS a
	LEFT JOIN WORK.RefCarrier4_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;



/* May */
PROC SQL;
  DROP TABLE WORK.OpCarrier5_&year_data;
  CREATE TABLE WORK.OpCarrier5_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2018.BCARRIER_LINE_05 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier5_&year_data;
  CREATE TABLE WORK.RefCarrier5_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2018.BCARRIER_CLAIMS_05 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier5_&year_data;
	CREATE TABLE WORK.OpRefCarrier5_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier5_&year_data AS a
	LEFT JOIN WORK.RefCarrier5_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* June */
PROC SQL;
  DROP TABLE WORK.OpCarrier6_&year_data;
  CREATE TABLE WORK.OpCarrier6_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2018.BCARRIER_LINE_06 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier6_&year_data;
  CREATE TABLE WORK.RefCarrier6_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2018.BCARRIER_CLAIMS_06 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier6_&year_data;
	CREATE TABLE WORK.OpRefCarrier6_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier6_&year_data AS a
	LEFT JOIN WORK.RefCarrier6_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* July */
PROC SQL;
  DROP TABLE WORK.OpCarrier7_&year_data;
  CREATE TABLE WORK.OpCarrier7_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2018.BCARRIER_LINE_07 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier7_&year_data;
  CREATE TABLE WORK.RefCarrier7_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2018.BCARRIER_CLAIMS_07 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier7_&year_data;
	CREATE TABLE WORK.OpRefCarrier7_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier7_&year_data AS a
	LEFT JOIN WORK.RefCarrier7_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* August */
PROC SQL;
  DROP TABLE WORK.OpCarrier8_&year_data;
  CREATE TABLE WORK.OpCarrier8_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2018.BCARRIER_LINE_08 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier8_&year_data;
  CREATE TABLE WORK.RefCarrier8_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2018.BCARRIER_CLAIMS_08 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier8_&year_data;
	CREATE TABLE WORK.OpRefCarrier8_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier8_&year_data AS a
	LEFT JOIN WORK.RefCarrier8_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* September */
PROC SQL;
  DROP TABLE WORK.OpCarrier9_&year_data;
  CREATE TABLE WORK.OpCarrier9_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2018.BCARRIER_LINE_09 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier9_&year_data;
  CREATE TABLE WORK.RefCarrier9_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2018.BCARRIER_CLAIMS_09 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier9_&year_data;
	CREATE TABLE WORK.OpRefCarrier9_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier9_&year_data AS a
	LEFT JOIN WORK.RefCarrier9_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* October */
PROC SQL;
  DROP TABLE WORK.OpCarrier10_&year_data;
  CREATE TABLE WORK.OpCarrier10_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2018.BCARRIER_LINE_10 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier10_&year_data;
  CREATE TABLE WORK.RefCarrier10_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2018.BCARRIER_CLAIMS_10 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier10_&year_data;
	CREATE TABLE WORK.OpRefCarrier10_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier10_&year_data AS a
	LEFT JOIN WORK.RefCarrier10_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* November */
PROC SQL;
  DROP TABLE WORK.OpCarrier11_&year_data;
  CREATE TABLE WORK.OpCarrier11_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2018.BCARRIER_LINE_11 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier11_&year_data;
  CREATE TABLE WORK.RefCarrier11_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2018.BCARRIER_CLAIMS_11 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier11_&year_data;
	CREATE TABLE WORK.OpRefCarrier11_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier11_&year_data AS a
	LEFT JOIN WORK.RefCarrier11_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;




/* December */
PROC SQL;
  DROP TABLE WORK.OpCarrier12_&year_data;
  CREATE TABLE WORK.OpCarrier12_&year_data AS
  SELECT DISTINCT a.PRF_PHYSN_NPI, a.BENE_ID, a.CLM_ID, b.CLM_FROM_DT, b.CLM_THRU_DT, a.CLM_THRU_DT AS claim_date
  FROM RIF2018.BCARRIER_LINE_12 AS a
  INNER JOIN WORK.Unique_Stays AS b
		ON a.BENE_ID=b.BENE_ID AND a.PRF_PHYSN_NPI=b.OP_PHYSN_NPI
  HAVING claim_date>=b.CLM_FROM_DT AND claim_date<=b.CLM_THRU_DT
  ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;

PROC SQL;
  DROP TABLE WORK.RefCarrier12_&year_data;
  CREATE TABLE WORK.RefCarrier12_&year_data AS
  SELECT DISTINCT RFR_PHYSN_NPI, a.BENE_ID, CLM_ID
  FROM RIF2018.BCARRIER_CLAIMS_12 AS a
  INNER JOIN IMC969SL.MajorJointPatients_Unique AS b
		ON a.BENE_ID=b.BENE_ID
  ORDER BY a.BENE_ID, CLM_ID, RFR_PHYSN_NPI;
QUIT;

PROC SQL;
	DROP TABLE WORK.OpRefCarrier12_&year_data;
	CREATE TABLE WORK.OpRefCarrier12_&year_data AS
	SELECT a.*, b.RFR_PHYSN_NPI
	FROM WORK.OpCarrier12_&year_data AS a
	LEFT JOIN WORK.RefCarrier12_&year_data AS b
		ON a.BENE_ID=b.BENE_ID AND a.CLM_ID=b.CLM_ID
	ORDER BY a.BENE_ID, CLM_ID, PRF_PHYSN_NPI;
QUIT;


/* Append all months */
DATA IMC969SL.ReferralsCarrier_&year_data;
	SET	WORK.OpRefCarrier1_&year_data
  		WORK.OpRefCarrier2_&year_data
		WORK.OpRefCarrier3_&year_data
		WORK.OpRefCarrier4_&year_data
		WORK.OpRefCarrier5_&year_data
		WORK.OpRefCarrier6_&year_data
		WORK.OpRefCarrier7_&year_data
		WORK.OpRefCarrier8_&year_data
		WORK.OpRefCarrier9_&year_data
		WORK.OpRefCarrier10_&year_data
		WORK.OpRefCarrier11_&year_data
		WORK.OpRefCarrier12_&year_data;
RUN;

